const e=["#ef4444","#3b82f6","#8b5cf6","#10b981","#f59e0b","#f97316","#06b6d4"];class t{popoverElement;offset;parsedCache=/* @__PURE__ */new WeakMap;rafId=null;lastRendered=null;isInitialized=!1;iconImg;iconSprite;iconText;titleLink;titleSpan;descriptionEl;initRetryCount=0;maxInitRetries=10;logError(e,t){}constructor(e=8){this.offset=e,this.waitForPopoverElement().then(()=>{this.initialize()}).catch(e=>{this.logError("PopoverManager: Initialization failed",e)})}waitForPopoverElement(){return new Promise((e,t)=>{const i=document.getElementById("global-popover");if(i)return this.popoverElement=i,void e();const o=new MutationObserver(()=>{const t=document.getElementById("global-popover");t&&(this.popoverElement=t,o.disconnect(),e())});o.observe(document.body,{childList:!0,subtree:!0}),setTimeout(()=>{o.disconnect(),t(new Error("Timeout waiting for #global-popover element"))},5e3)})}initialize(){if(this.iconImg=this.popoverElement.querySelector(".pd-popover-icon-img"),this.iconSprite=this.popoverElement.querySelector(".pd-popover-icon-sprite"),this.iconText=this.popoverElement.querySelector(".pd-popover-icon-text"),this.titleLink=this.popoverElement.querySelector(".pd-popover-title-link"),this.titleSpan=this.popoverElement.querySelector(".pd-popover-title-span"),this.descriptionEl=this.popoverElement.querySelector(".pd-popover-description"),!(this.iconImg&&this.iconSprite&&this.iconText&&this.titleLink&&this.titleSpan&&this.descriptionEl))return this.initRetryCount++,this.initRetryCount>=this.maxInitRetries?void this.logError(`PopoverManager: Failed to initialize after ${this.maxInitRetries} retries. Required child elements are missing.`):void setTimeout(()=>{this.initialize()},100);this.popoverElement.style.removeProperty("opacity"),this.popoverElement.style.removeProperty("visibility"),this.isInitialized=!0}show(e){if(!this.isInitialized)return;const t=this.getPopoverData(e);t?(this.popoverElement.classList.add("is-visible"),this.isSameData(this.lastRendered,t)||(this.updatePopoverContent(t),this.lastRendered={...t}),this.schedulePosition(e)):this.hide()}hide(){null!==this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null),this.popoverElement.classList.remove("is-visible")}destroy(){this.hide(),this.lastRendered=null,this.isInitialized=!1}updatePopoverContent(e){if(!(this.iconImg&&this.iconSprite&&this.iconText&&this.titleLink&&this.titleSpan&&this.descriptionEl))return void this.logError("PopoverManager: Required DOM elements are not available for content update");const t=e.title.charAt(0).toUpperCase(),i=this.getIconColor(e.title);if(this.popoverElement.classList.remove("is-logo-visible","is-sprite-visible","is-text-visible"),e.logoIconClass){const s=(o=e.logoIconClass)?o.startsWith("zh-ctm-icon")?"zh-ctm-icon":o.startsWith("ctm-icon")?"ctm-icon":o.startsWith("icon")?"icon":null:null;s?(this.iconSprite.className=`pd-popover-icon-sprite ${s} ${e.logoIconClass}`,this.popoverElement.classList.add("is-sprite-visible")):(this.iconText.textContent=t,this.iconText.style.backgroundColor=i,this.popoverElement.classList.add("is-text-visible"))}else e.logoUrl?(this.iconImg.src=e.logoUrl,this.iconImg.alt=e.title,this.popoverElement.classList.add("is-logo-visible")):(this.iconText.textContent=t,this.iconText.style.backgroundColor=i,this.popoverElement.classList.add("is-text-visible"));var o;e.href?(this.titleLink.href=e.href,this.titleLink.textContent=e.title,this.popoverElement.classList.add("is-link-title")):(this.titleSpan.textContent=e.title,this.popoverElement.classList.remove("is-link-title")),this.descriptionEl.textContent=e.description}isSameData(e,t){return!!e&&(e.title===t.title&&e.description===t.description&&e.href===t.href&&(e.logoUrl||"")===(t.logoUrl||"")&&(e.logoIconClass||"")===(t.logoIconClass||""))}getPopoverData(e){if(this.parsedCache.has(e))return this.parsedCache.get(e)??null;const t=e.dataset.popover;if(!t)return this.parsedCache.set(e,null),null;try{const i=JSON.parse(t);if(!i.title||!i.description)return this.parsedCache.set(e,null),null;const o={title:i.title,description:i.description,href:i.href,logoUrl:i.logoUrl||i.logo,logoIconClass:i.logoIconClass};return this.parsedCache.set(e,o),o}catch{return this.parsedCache.set(e,null),null}}schedulePosition(e){null!==this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame(()=>this.performPosition(e))}performPosition(e){this.rafId=null;const t=e.getBoundingClientRect(),i=this.popoverElement.getBoundingClientRect(),o=window.innerWidth,s=window.innerHeight,n=10,r=document.querySelector("header.scroll-hide"),a=document.querySelector("header.header-responsive"),l=r?Math.max(0,r.getBoundingClientRect().bottom):0,h=a?Math.max(0,a.getBoundingClientRect().bottom):0,d=Math.max(l,h);let c=t.left+t.width/2-i.width/2,p=t.top-i.height-this.offset;this.popoverElement.classList.remove("is-above","is-below"),p<Math.max(n,d+n)?(p=t.bottom+this.offset,this.popoverElement.classList.add("is-below")):this.popoverElement.classList.add("is-above"),c<n&&(c=n),c+i.width>o-n&&(c=o-i.width-n),p+i.height>s-n&&(p=s-i.height-n),this.popoverElement.style.left=`${Math.max(0,c)}px`,this.popoverElement.style.top=`${Math.max(d+n,p)}px`}reposition(e){this.isInitialized&&this.schedulePosition(e)}getIconColor(t){return function(t){if(!t||0===t.length)return"#6b7280";let i=0;const o=t.length;for(let e=0;e<o;e++)i=(i<<5)-i+t.charCodeAt(e)&4294967295;const s=Math.abs(i)%e.length;return e[s]||"#6b7280"}(t)}}class i{manager;stickyTarget=null;hoverTarget=null;hideTimeoutId=null;isMobileMode;showDelay=50;hideDelay=100;boundHandlers={mouseOver:this.handleMouseOver.bind(this),mouseOut:this.handleMouseOut.bind(this),popoverEnter:this.handlePopoverEnter.bind(this),popoverLeave:this.handlePopoverLeave.bind(this),globalClick:this.handleGlobalClick.bind(this),viewportChange:this.handleViewportChange.bind(this)};resizeObserver=null;logError(e){}constructor(e,t=!1){this.manager=e,this.isMobileMode=t,this.waitForManagerInitialization()}async waitForManagerInitialization(){for(let e=0;e<50;e++){if(this.manager.popoverElement&&this.manager.isInitialized)return void this.bindListeners();await new Promise(e=>setTimeout(e,100))}this.logError("PopoverController: PopoverManager 初始化超时")}bindListeners(){this.isMobileMode||(document.addEventListener("mouseover",this.boundHandlers.mouseOver),document.addEventListener("mouseout",this.boundHandlers.mouseOut),this.manager.popoverElement&&(this.manager.popoverElement.addEventListener("mouseenter",this.boundHandlers.popoverEnter),this.manager.popoverElement.addEventListener("mouseleave",this.boundHandlers.popoverLeave))),document.addEventListener("click",this.boundHandlers.globalClick,!0),window.addEventListener("scroll",this.boundHandlers.viewportChange,{passive:!0}),window.addEventListener("resize",this.boundHandlers.viewportChange,{passive:!0}),document.addEventListener("scroll",this.boundHandlers.viewportChange,{passive:!0,capture:!0})}unbindListeners(){this.isMobileMode||(document.removeEventListener("mouseover",this.boundHandlers.mouseOver),document.removeEventListener("mouseout",this.boundHandlers.mouseOut),this.manager.popoverElement&&(this.manager.popoverElement.removeEventListener("mouseenter",this.boundHandlers.popoverEnter),this.manager.popoverElement.removeEventListener("mouseleave",this.boundHandlers.popoverLeave))),document.removeEventListener("click",this.boundHandlers.globalClick,!0),window.removeEventListener("scroll",this.boundHandlers.viewportChange),window.removeEventListener("resize",this.boundHandlers.viewportChange),document.removeEventListener("scroll",this.boundHandlers.viewportChange,!0)}handleViewportChange(){const e=this.stickyTarget||this.hoverTarget;if(!e)return;if(!document.body.contains(e))return void this.clearStickyState();const t=e.getBoundingClientRect(),i=window.innerWidth,o=window.innerHeight,s=getComputedStyle(e),n="hidden"===s.visibility||"none"===s.display,r=0===t.width&&0===t.height,a=null===e.offsetParent&&"fixed"!==s.position,l=t.bottom<=0||t.top>=o||t.right<=0||t.left>=i;n||r||a||l?this.clearStickyState():this.manager.reposition(e)}handleMouseOver(e){const t=e.target;if(!t)return;const i=t.closest("[data-popover]");i&&this.stickyTarget&&i!==this.stickyTarget&&this.clearStickyState(),this.stickyTarget||i&&i!==this.hoverTarget&&(this.manager.hide(),this.hoverTarget=i,this.scheduleShow(i))}handleMouseOut(e){if(this.stickyTarget)return;const t=e.relatedTarget;if(e.target.closest("[data-popover]")){if(t){const e=this.manager.popoverElement.contains(t),i=null!==t.closest("[data-popover]");if(e||i)return}this.hoverTarget=null,this.scheduleHide()}}handlePopoverEnter(){this.stickyTarget||this.hideTimeoutId&&(clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null)}handlePopoverLeave(e){if(this.stickyTarget)return;const t=e.relatedTarget;t&&t.closest("[data-popover]")||(this.hoverTarget=null,this.scheduleHide())}handleGlobalClick(e){const t=e.target;if(!t)return;const i=t.closest("[data-popover]");if(i){if(t.closest("a"))return;return void this.toggleStickyState(i)}this.manager.popoverElement.contains(t)||this.clearStickyState()}toggleStickyState(e){this.stickyTarget===e?this.clearStickyState():(this.stickyTarget=e,this.hoverTarget=e,this.hideTimeoutId&&(clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null),"ResizeObserver"in window&&(this.resizeObserver||(this.resizeObserver=new ResizeObserver(()=>{const e=this.stickyTarget||this.hoverTarget;e&&this.manager.reposition(e)})),this.resizeObserver.observe(e)),this.manager.show(e))}clearStickyState(){if(this.stickyTarget){if(this.resizeObserver)try{this.resizeObserver.unobserve(this.stickyTarget)}catch{}this.stickyTarget=null,this.hoverTarget=null,this.manager.hide()}}scheduleShow(e){this.hideTimeoutId&&(clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null),setTimeout(()=>{this.hoverTarget===e&&this.manager.show(e)},this.showDelay)}scheduleHide(){this.hideTimeoutId&&clearTimeout(this.hideTimeoutId),this.hideTimeoutId=window.setTimeout(()=>{this.manager.hide(),this.hideTimeoutId=null},this.hideDelay)}destroy(){this.hideTimeoutId&&(clearTimeout(this.hideTimeoutId),this.hideTimeoutId=null),this.unbindListeners(),this.stickyTarget=null,this.hoverTarget=null,this.manager.destroy()}}document.addEventListener("astro:page-load",()=>{window.popoverController&&window.popoverController.destroy();let e=!1;try{const t=!(!window.matchMedia||!window.matchMedia("(hover: none), (pointer: coarse)").matches),i=!(!window.matchMedia||!(window.matchMedia("(hover: hover) and (pointer: fine)").matches||window.matchMedia("(any-hover: hover)").matches||window.matchMedia("(any-pointer: fine)").matches)),o=navigator,s="number"==typeof o.maxTouchPoints&&o.maxTouchPoints>0;e=t||s&&!i}catch{}const o=new t;window.popoverController=new i(o,e)});export{i as PopoverController};
